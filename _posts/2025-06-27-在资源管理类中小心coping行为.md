---
layout: post
title: Effective C++ æ¡æ¬¾14ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­å°å¿ƒcopingè¡Œä¸º
categories: [é˜…è¯»ç¬”è®°, Effective C++]
tag: [Effective C++]
date: '2025-06-27 18:46:01 +0800'
---

## **Effective C++ æ¡æ¬¾14 ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­å°å¿ƒcopingè¡Œä¸º**

---

<br />

> **åœ¨èµ„æºç®¡ç†ç±»ä¸­å°å¿ƒå¤„ç†æ‹·è´è¡Œä¸º**ï¼ˆThink carefully about copying behavior in resource-managing classesï¼‰ã€‚è¯¥æ¡æ¬¾æ˜¯å¯¹æ¡æ¬¾13ï¼ˆä»¥å¯¹è±¡ç®¡ç†èµ„æºï¼‰çš„æ·±åŒ–ï¼Œå¼ºè°ƒå½“RAIIå¯¹è±¡è¢«å¤åˆ¶æ—¶éœ€è®¾è®¡åˆç†çš„æ‹·è´è¯­ä¹‰ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´**èµ„æºé‡å¤é‡Šæ”¾**ã€**æ³„æ¼**æˆ–**æœªå®šä¹‰è¡Œä¸º**!
{: .prompt-warning }

### ğŸ” **ä¸€ã€é—®é¢˜èƒŒæ™¯ï¼šé»˜è®¤æ‹·è´è¡Œä¸ºçš„é£é™©**  

RAIIç±»é€šè¿‡æ„é€ å‡½æ•°è·å–èµ„æºã€ææ„å‡½æ•°é‡Šæ”¾èµ„æºã€‚ä½†å½“å¯¹è±¡è¢«æ‹·è´æ—¶ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„é»˜è®¤æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦å¯èƒ½å¼•å‘é—®é¢˜ï¼š  

- **æµ…æ‹·è´**ï¼šå¤šä¸ªå¯¹è±¡æŒæœ‰åŒä¸€èµ„æºçš„åŸå§‹æŒ‡é’ˆï¼Œææ„æ—¶é‡å¤é‡Šæ”¾èµ„æºï¼ˆå¦‚`delete`åŒä¸€å†…å­˜ï¼‰ã€‚  
- **èµ„æºæ³„æ¼**ï¼šæ‹·è´ååŸå¯¹è±¡å¤±å»èµ„æºæ‰€æœ‰æƒï¼Œææ„æ—¶æœªé‡Šæ”¾èµ„æºã€‚  

**ç¤ºä¾‹**ï¼š  

```cpp
class ResourceManage {
public:
    explicit ResourceManage(int* p) : ptr(p) { save(ptr); }
    ~ResourceManage() { release(ptr); }
private:
    int* ptr;
    // é»˜è®¤æ‹·è´ï¼šptrè¢«æµ…æ‹·è´
};

int main() {
    int x = 10;
    ResourceManage m1(&x);
    ResourceManage m2(m1); // æ‹·è´åm1å’Œm2æŒ‡å‘åŒä¸€èµ„æº
} // ææ„æ—¶release()è¢«è°ƒç”¨ä¸¤æ¬¡ â†’ å´©æºƒï¼
```

---

### ğŸ› ï¸ **äºŒã€è§£å†³æ–¹æ¡ˆï¼šå››ç§æ‹·è´ç­–ç•¥**  
æ ¹æ®èµ„æºç‰¹æ€§ï¼Œé€‰æ‹©ä»¥ä¸‹ç­–ç•¥ä¹‹ä¸€ï¼š  

#### **1. ç¦æ­¢æ‹·è´ï¼ˆProhibit Copyingï¼‰**  

**é€‚ç”¨åœºæ™¯**ï¼šèµ„æºä¸å¯å…±äº«ï¼ˆå¦‚äº’æ–¥é”ã€æ–‡ä»¶å¥æŸ„ï¼‰ã€‚  

**å®ç°æ–¹å¼**ï¼š  
- å£°æ˜æ‹·è´æ“ä½œä¸º`private`æˆ–ä½¿ç”¨`= delete`ã€‚  
- ç»§æ‰¿ä¸å¯æ‹·è´çš„åŸºç±»ï¼ˆå¦‚`Uncopyable`ï¼‰ã€‚  

**ä»£ç ç¤ºä¾‹**ï¼š  

```cpp
class Lock {
public:
    explicit Lock(Mutex* pm) : mutexPtr(pm) { lock(mutexPtr); }
    ~Lock() { unlock(mutexPtr); }
private:
    Mutex* mutexPtr;
    Lock(const Lock&) = delete;            // ç¦æ­¢æ‹·è´æ„é€ 
    Lock& operator=(const Lock&) = delete; // ç¦æ­¢èµ‹å€¼
};
```

#### **2. å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰**  

**é€‚ç”¨åœºæ™¯**ï¼šèµ„æºå¯å…±äº«ï¼ˆå¦‚å†…å­˜ã€æ•°æ®åº“è¿æ¥ï¼‰ã€‚  

**å®ç°æ–¹å¼**ï¼š  
- ä½¿ç”¨`std::shared_ptr`ç®¡ç†èµ„æºï¼Œé€šè¿‡**è‡ªå®šä¹‰åˆ é™¤å™¨**ï¼ˆdeleterï¼‰å®šä¹‰é‡Šæ”¾é€»è¾‘ï¼ˆé`delete`ï¼‰ã€‚  

**ä»£ç ç¤ºä¾‹**ï¼ˆç®¡ç†äº’æ–¥é”ï¼‰ï¼š  

```cpp
class Lock {
public:
    explicit Lock(Mutex* pm) 
        : mutexPtr(pm, unlock) {  // è‡ªå®šä¹‰åˆ é™¤å™¨unlock
        lock(mutexPtr.get());
    }
    // æ— éœ€å®šä¹‰ææ„å‡½æ•°ï¼shared_ptrè‡ªåŠ¨è°ƒç”¨unlock
private:
    std::shared_ptr<Mutex> mutexPtr;
};
```

#### **3. æ·±æ‹·è´ï¼ˆDeep Copyingï¼‰**  

**é€‚ç”¨åœºæ™¯**ï¼šèµ„æºéœ€ç‹¬ç«‹å‰¯æœ¬ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ã€‚  

**å®ç°æ–¹å¼**ï¼š  
- è‡ªå®šä¹‰æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦ï¼Œå¤åˆ¶åº•å±‚èµ„æºã€‚  

**ä»£ç ç¤ºä¾‹**ï¼š  

```cpp
class ResourceManage {
public:
    explicit ResourceManage(int* p) : ptr(new int(*p)) {}
    ~ResourceManage() { delete ptr; }

    // æ·±æ‹·è´
    ResourceManage(const ResourceManage& other) 
        : ptr(new int(*other.ptr)) {} 

    ResourceManage& operator=(const ResourceManage& other) {
        if (this != &other) {
            int* newPtr = new int(*other.ptr);
            delete ptr;    // é‡Šæ”¾æ—§èµ„æº
            ptr = newPtr;
        }
        return *this;
    }
private:
    int* ptr;
};
```

#### **4. è½¬ç§»æ‰€æœ‰æƒï¼ˆTransfer Ownershipï¼‰**  

**é€‚ç”¨åœºæ™¯**ï¼šèµ„æºå”¯ä¸€æ€§è¦æ±‚é«˜ï¼ˆå¦‚`std::unique_ptr`ï¼‰ã€‚  

**å®ç°æ–¹å¼**ï¼š  
- ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ï¼ˆC++11+ï¼‰ï¼Œå°†æ‹·è´æ“ä½œæ”¹ä¸ºç§»åŠ¨æ“ä½œã€‚  
- **æ³¨æ„**ï¼š`auto_ptr`ï¼ˆå·²å¼ƒç”¨ï¼‰å› æ‰€æœ‰æƒè½¬ç§»æ˜“å¼•å‘é‡æŒ‡é’ˆï¼Œæ¨èç”¨`unique_ptr`æ›¿ä»£ã€‚  

---

### âš ï¸ **ä¸‰ã€å®è·µé™·é˜±ä¸è¿›é˜¶æŠ€å·§**  

1. **è‡ªå®šä¹‰åˆ é™¤å™¨ï¼ˆDeleterï¼‰**  
   - `shared_ptr`æ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œé€‚åº”éå†…å­˜èµ„æºï¼ˆå¦‚`fclose`å…³é—­æ–‡ä»¶ï¼‰ï¼š  
   - 
     ```cpp
     std::shared_ptr<FILE> filePtr(fopen("a.txt", "r"), fclose);
     ```

2. **å¾ªç¯å¼•ç”¨é—®é¢˜**  
   - `shared_ptr`ç›¸äº’å¼•ç”¨å¯¼è‡´èµ„æºæ— æ³•é‡Šæ”¾ â†’ ç”¨`weak_ptr`æ‰“ç ´å¾ªç¯ã€‚  

3. **æä¾›åŸå§‹èµ„æºè®¿é—®æ¥å£**  
   - RAIIç±»éœ€æä¾›`get()`æˆ–é‡è½½`operator->`/`operator*`ï¼Œä»¥ä¾¿å…¼å®¹éœ€è¦åŸå§‹èµ„æºçš„APIã€‚  

---

### ğŸ’ **å››ã€æ€»ç»“ä¸æœ€ä½³å®è·µ**  

- **æ ¸å¿ƒåŸåˆ™**ï¼šè®¾è®¡RAIIç±»æ—¶ï¼Œ**å¿…é¡»æ˜¾å¼å®šä¹‰æ‹·è´è¡Œä¸º**ï¼Œé¿å…ä¾èµ–ç¼–è¯‘å™¨é»˜è®¤å®ç°ã€‚  
- **ç­–ç•¥é€‰æ‹©**ï¼š  
  - ç‹¬å èµ„æº â†’ **ç¦æ­¢æ‹·è´**  
  - å¯å…±äº«èµ„æº â†’ **å¼•ç”¨è®¡æ•°**ï¼ˆ`shared_ptr + è‡ªå®šä¹‰åˆ é™¤å™¨`ï¼‰  
  - éœ€ç‹¬ç«‹å‰¯æœ¬ â†’ **æ·±æ‹·è´**  
  - å”¯ä¸€æ€§èµ„æº â†’ **è½¬ç§»æ‰€æœ‰æƒ**ï¼ˆç§»åŠ¨è¯­ä¹‰ï¼‰  
- **ç°ä»£C++æ¨è**ï¼šä¼˜å…ˆä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼ˆ`unique_ptr`/`shared_ptr`ï¼‰ï¼Œè€Œéæ‰‹åŠ¨å®ç°RAIIç±»ã€‚  

> é€šè¿‡åˆç†è®¾è®¡æ‹·è´è¡Œä¸ºï¼ŒRAIIæœºåˆ¶æ‰èƒ½çœŸæ­£å®ç°èµ„æºçš„è‡ªåŠ¨åŒ–ã€å®‰å…¨åŒ–ç®¡ç†ï¼Œæˆä¸ºC++èµ„æºç®¡ç†çš„æ ¸å¿ƒèŒƒå¼ã€‚
