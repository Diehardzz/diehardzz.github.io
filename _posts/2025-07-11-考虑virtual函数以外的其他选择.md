---
layout: post
title: Effective C++ æ¡æ¬¾35ï¼šè€ƒè™‘virtualå‡½æ•°ä»¥å¤–çš„å…¶ä»–é€‰æ‹©
categories: [é˜…è¯»ç¬”è®°, Effective C++]
tag: [Effective C++]
date: '2025-07-11 02:47:11 +0800'
---

## **Effective C++ æ¡æ¬¾35 ï¼šè€ƒè™‘virtualå‡½æ•°ä»¥å¤–çš„å…¶ä»–é€‰æ‹©**

---

<br/>

> ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰é€šè¿‡å¯¹è±¡ç»„åˆä»£æ›¿ç±»ç»§æ‰¿ï¼Œå°†ç®—æ³•æˆ–è¡Œä¸ºå°è£…ä¸ºç‹¬ç«‹çš„ç­–ç•¥ç±»ï¼Œä»è€Œé¿å…è™šå‡½æ•°ç»§æ‰¿å¸¦æ¥çš„è€¦åˆå’Œæ€§èƒ½å¼€é”€ã€‚åœ¨éœ€è¦åŠ¨æ€åˆ‡æ¢è¡Œä¸ºã€å¤ç”¨ç®—æ³•æˆ–å‡å°‘å†…å­˜çš„åœºæ™¯ä¸‹ï¼Œç­–ç•¥æ¨¡å¼æ˜¯æ›´çµæ´»çš„é€‰æ‹©ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šâ€‹â€‹â€œä¼˜å…ˆä½¿ç”¨å¯¹è±¡ç»„åˆï¼Œè€Œéç±»ç»§æ‰¿â€â€‹â€‹ï¼ˆFavor Composition Over Inheritanceï¼‰ã€‚
{: .prompt-tip}

### ğŸ§  **ä¸€ã€æ ¸å¿ƒé—®é¢˜ï¼šè™šå‡½æ•°çš„å±€é™æ€§**

è™šå‡½æ•°é€šè¿‡ç»§æ‰¿ä½“ç³»å®ç°å¤šæ€ï¼Œä½†å­˜åœ¨ä»¥ä¸‹ç—›ç‚¹ï¼š
1. **ç ´åå°è£…æ€§**  
   æ´¾ç”Ÿç±»éœ€äº†è§£åŸºç±»å®ç°ç»†èŠ‚æ‰èƒ½æ­£ç¡®é‡å†™è™šå‡½æ•°ã€‚
2. **è€¦åˆåº¦é«˜**  
   åŸºç±»å’Œæ´¾ç”Ÿç±»çš„å®ç°ç´§å¯†ç»‘å®šï¼Œä¿®æ”¹åŸºç±»å¯èƒ½å½±å“æ‰€æœ‰æ´¾ç”Ÿç±»ã€‚
3. **åŠ¨æ€ç»‘å®šå¼€é”€**  
   è™šå‡½æ•°è°ƒç”¨æ¶‰åŠè™šè¡¨ï¼ˆvtableï¼‰æŸ¥æ‰¾ï¼Œå­˜åœ¨é—´æ¥è°ƒç”¨æˆæœ¬ï¼ˆå°½ç®¡é€šå¸¸å¯å¿½ç•¥ï¼‰ã€‚
4. **æ‰©å±•æ€§å—é™**  
   æ–°å¢è¡Œä¸ºéœ€ä¿®æ”¹ç»§æ‰¿ä½“ç³»ï¼Œè¿åå¼€é—­åŸåˆ™ï¼ˆOCPï¼‰ã€‚

---

### ğŸ”„ **äºŒã€æ›¿ä»£æ–¹æ¡ˆ 1ï¼šNVIï¼ˆNon-Virtual Interfaceï¼‰æ¨¡å¼**

#### **åŸç†**

- **å…¬æœ‰éè™šå‡½æ•°** ä½œä¸ºæ¥å£ï¼ˆæ§åˆ¶æµç¨‹ï¼‰ï¼Œ**ç§æœ‰è™šå‡½æ•°** å®ç°å…·ä½“è¡Œä¸ºï¼ˆå¯è¢«å­ç±»å®šåˆ¶ï¼‰ã€‚
- æœ¬è´¨æ˜¯ **æ¨¡æ¿æ–¹æ³•æ¨¡å¼** çš„å˜ä½“ã€‚

```cpp
class GameCharacter {
public:
    int CalculateHealth() const {   // å…¬æœ‰éè™šæ¥å£
        // å‰ç½®é€»è¾‘ï¼ˆå¦‚åŠ é”ã€æ—¥å¿—ï¼‰
        int health = DoCalculateHealth(); 
        // åç½®é€»è¾‘ï¼ˆå¦‚éªŒè¯ã€è§£é”ï¼‰
        return health;
    }
private:
    virtual int DoCalculateHealth() const { // ç§æœ‰è™šå‡½æ•°
        return 100; // é»˜è®¤å®ç°
    }
};
```
#### **ä¼˜åŠ¿**

- **æµç¨‹ç»Ÿä¸€æ§åˆ¶**ï¼šåœ¨è°ƒç”¨è™šå‡½æ•°å‰åæ’å…¥é€šç”¨é€»è¾‘ï¼ˆå¦‚é”ã€æ—¥å¿—ã€æ ¡éªŒï¼‰ã€‚
- **é¿å…å†—ä½™ä»£ç **ï¼šæ´¾ç”Ÿç±»åªéœ€å…³æ³¨æ ¸å¿ƒé€»è¾‘ã€‚
- **æ”¯æŒåå˜è¿”å›ç±»å‹**ï¼šéè™šæ¥å£å¯è¿”å›åŸºç±»ç±»å‹ï¼Œè™šå‡½æ•°è¿”å›æ´¾ç”Ÿç±»å‹ã€‚

#### **å±€é™**

- è™šå‡½æ•°ä»éœ€å®šä¹‰åœ¨ç»§æ‰¿ä½“ç³»å†…ï¼Œæ— æ³•å®Œå…¨è§£è€¦ã€‚

---

### ğŸ¯ **ä¸‰ã€æ›¿ä»£æ–¹æ¡ˆ 2ï¼šå‡½æ•°æŒ‡é’ˆç­–ç•¥ï¼ˆStrategy æ¨¡å¼ï¼‰**

> `using`åœ¨æ­¤å¤„å’Œ`typedef`æ•ˆæœä¸€è‡´ï¼Œä¸ºå‡½æ•°æŒ‡é’ˆå®šä¹‰åˆ«å
{: .prompt-tip}

#### **åŸç†**

- å°†è¡Œä¸ºæŠ½å–ä¸ºå¤–éƒ¨å‡½æ•°ï¼Œé€šè¿‡å‡½æ•°æŒ‡é’ˆæ³¨å…¥ã€‚

```cpp
int DefaultHealthCalc(const GameCharacter& gc); // å¤–éƒ¨å‡½æ•°

class GameCharacter {
public:
    using HealthCalcFunc = int (*)(const GameCharacter&);
    explicit GameCharacter(HealthCalcFunc hcf = DefaultHealthCalc) 
        : healthFunc(hcf) {}
    
    int CalculateHealth() const { 
        return healthFunc(*this); 
    }
private:
    HealthCalcFunc healthFunc;
};

// ä½¿ç”¨ç¤ºä¾‹
int CustomHealthCalc(const GameCharacter&); 
GameCharacter enemy(CustomHealthCalc); // æ³¨å…¥è‡ªå®šä¹‰è®¡ç®—å‡½æ•°
```

#### **ä¼˜åŠ¿**

- **è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢è¡Œä¸º**ï¼šé€šè¿‡ `SetHealthFunc` æ–¹æ³•å¯éšæ—¶ä¿®æ”¹ç­–ç•¥ã€‚
- **è§£è€¦ç»§æ‰¿ä½“ç³»**ï¼šå¥åº·è®¡ç®—ä¸è§’è‰²ç±»æ— å…³ã€‚

#### **å±€é™**

- **æ— æ³•è®¿é—®ç§æœ‰æˆå‘˜**ï¼šéœ€é€šè¿‡å‹å…ƒæˆ–å…¬æœ‰æ¥å£æš´éœ²å†…éƒ¨çŠ¶æ€ï¼Œç ´åå°è£…ã€‚

---

### ğŸ§© **å››ã€æ›¿ä»£æ–¹æ¡ˆ 3ï¼š`std::function` ç­–ç•¥ï¼ˆå¢å¼º Strategy æ¨¡å¼ï¼‰**

#### **åŸç†**

- ä½¿ç”¨ `std::function` æ›¿ä»£å‡½æ•°æŒ‡é’ˆï¼Œæ”¯æŒ **ä»»ä½•å¯è°ƒç”¨å¯¹è±¡**ï¼ˆå‡½æ•°ã€å‡½æ•°å¯¹è±¡ã€lambdaã€æˆå‘˜å‡½æ•°ç­‰ï¼‰ã€‚

```cpp
#include <functional>
class GameCharacter {
public:
    using HealthCalcFunc = std::function<int (const GameCharacter&)>;
    explicit GameCharacter(HealthCalcFunc hcf = DefaultHealthCalc) 
        : healthFunc(hcf) {}
    
    int CalculateHealth() const { 
        return healthFunc(*this); 
    }
private:
    HealthCalcFunc healthFunc;
};

// ä½¿ç”¨ç¤ºä¾‹ï¼šç»‘å®šæˆå‘˜å‡½æ•°
class GameLevel {
public:
    float Health(const GameCharacter&) const;//éšå¼è½¬æ¢å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±â€‹ï¼šå°æ•°éƒ¨åˆ†è¢«ä¸¢å¼ƒï¼Œå¯¼è‡´ç²¾åº¦æŸå¤±
};
GameLevel currentLevel;
//å¯ä»¥ç”¨lambdaè¡¨è¾¾å¼ä»¥åŠstd::mem_fnæ›¿æ¢bind
GameCharacter pc(std::bind(&GameLevel::Health, &currentLevel, std::placeholders::_1));
```

#### **ä¼˜åŠ¿**

- **æè‡´çµæ´»æ€§**ï¼šæ”¯æŒ lambdaã€bind è¡¨è¾¾å¼ã€å‡½æ•°å¯¹è±¡ç­‰ã€‚
- **éšå¼æ¥å£å…¼å®¹**ï¼šè¿”å›å€¼åªéœ€å¯è½¬æ¢ä¸º `int`ï¼Œå‚æ•°åªéœ€å…¼å®¹ `const GameCharacter&`ã€‚
- **æˆå‘˜å‡½æ•°ç»‘å®š**ï¼šé€šè¿‡ `std::bind` è§£å†³ `this` æŒ‡é’ˆé—®é¢˜ã€‚

#### **é€‚ç”¨åœºæ™¯**

- éœ€é«˜åº¦å®šåˆ¶è¡Œä¸ºçš„ç³»ç»Ÿï¼ˆå¦‚æ¸¸æˆ AIã€å›è°ƒæœºåˆ¶ï¼‰ã€‚

---

### ğŸ—ï¸ **äº”ã€æ›¿ä»£æ–¹æ¡ˆ 4ï¼šä¼ ç»Ÿ Strategy æ¨¡å¼ï¼ˆæ¥å£ç»§æ‰¿ï¼‰**

#### **åŸç†**

- å°†è¡Œä¸ºæŠ½è±¡ä¸ºç‹¬ç«‹æ¥å£ï¼Œé€šè¿‡ç»„åˆæ³¨å…¥ã€‚

```cpp
class HealthCalcFunc {
public:
    virtual int Calc(const GameCharacter& gc) const = 0;
    virtual ~HealthCalcFunc() = default;
};

class DefaultHealthCalc : public HealthCalcFunc { /*...*/ };

class GameCharacter {
public:
    explicit GameCharacter(HealthCalcFunc* phcf = new DefaultHealthCalc()) 
        : pHealthFunc(phcf) {}
    
    int CalculateHealth() const { 
        return pHealthFunc->Calc(*this); 
    }
private:
    HealthCalcFunc* pHealthFunc;
};
```

#### **ä¼˜åŠ¿**

- **å®Œå…¨è§£è€¦**ï¼šå¥åº·è®¡ç®—é€»è¾‘ç‹¬ç«‹äºè§’è‰²ç±»ï¼Œå¯å•ç‹¬æ‰©å±•ã€‚
- **å¤šæ€èƒ½åŠ›ä¿ç•™**ï¼šé€šè¿‡ `HealthCalcFunc` çš„å­ç±»å®ç°ä¸åŒç®—æ³•ã€‚

#### **å±€é™**
- **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šéœ€è°¨æ…å¤„ç† `HealthCalcFunc*` çš„æ‰€æœ‰æƒï¼ˆå¯ç”¨æ™ºèƒ½æŒ‡é’ˆä¼˜åŒ–ï¼‰ã€‚

---

### âš–ï¸ **å…­ã€æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—**

| **æ–¹æ¡ˆ**                | é€‚ç”¨åœºæ™¯                                     | ä¼˜ç‚¹                             | ç¼ºç‚¹                       |
| ----------------------- | -------------------------------------------- | -------------------------------- | -------------------------- |
| **NVI æ¨¡å¼**            | éœ€ç»Ÿä¸€æ§åˆ¶æµç¨‹ï¼ˆå¦‚æ—¥å¿—ã€é”ï¼‰çš„åœºæ™¯           | å°è£…æµç¨‹é€»è¾‘ï¼Œæ´¾ç”Ÿç±»èšç„¦æ ¸å¿ƒ     | è¡Œä¸ºä»ç»‘å®šåœ¨ç»§æ‰¿ä½“ç³»ä¸­     |
| **å‡½æ•°æŒ‡é’ˆç­–ç•¥**        | è¡Œä¸ºç®€å•ä¸”æ— éœ€ç§æœ‰æ•°æ®çš„åœºæ™¯                 | è½»é‡çº§ï¼ŒåŠ¨æ€æ›¿æ¢                 | ç ´åå°è£…æ€§                 |
| **`std::function`ç­–ç•¥** | éœ€é«˜åº¦çµæ´»æ³¨å…¥è¡Œä¸ºçš„åœºæ™¯ï¼ˆå¦‚å›è°ƒã€é…ç½®é©±åŠ¨ï¼‰ | æ”¯æŒä»»æ„å¯è°ƒç”¨å¯¹è±¡ï¼Œæ¥å£å…¼å®¹æ€§å¼º | è¯­æ³•ç¨å¤æ‚ï¼ˆå°¤å…¶ `bind`ï¼‰  |
| **ä¼ ç»Ÿ Strategy æ¨¡å¼**  | è¡Œä¸ºå¤æ‚ä¸”éœ€ç‹¬ç«‹æ¼”åŒ–çš„ç³»ç»Ÿ                   | å®Œå…¨è§£è€¦ï¼Œç¬¦åˆå¼€é—­åŸåˆ™           | éœ€é¢å¤–ç®¡ç†ç­–ç•¥å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ |

---

### ğŸ’ **ä¸ƒã€æ ¸å¿ƒå‡†åˆ™ä¸æœ€ä½³å®è·µ**

1. **ä¼˜å…ˆé€‰æ‹©éä¾µå…¥å¼æ–¹æ¡ˆ**ï¼š  
   è‹¥è¡Œä¸ºä¸ç±»çŠ¶æ€æ— å…³ï¼Œç”¨ `std::function` æˆ–å‡½æ•°æŒ‡é’ˆï¼ˆé¿å…ç»§æ‰¿è†¨èƒ€ï¼‰ã€‚
2. **å°è£…ä¸æ€§èƒ½æƒè¡¡**ï¼š  
   - è™šå‡½æ•°é€‚åˆç´§å¯†å…³è”çš„è¡Œä¸ºï¼ˆå¦‚â€œè§’è‰²ç»˜åˆ¶â€ï¼‰ã€‚
   - ç­–ç•¥æ¨¡å¼é€‚åˆæ­£äº¤åŠŸèƒ½ï¼ˆå¦‚â€œä¼¤å®³è®¡ç®—â€â€œAI è¡Œä¸ºâ€ï¼‰ã€‚
3. **é¿å…è¿‡åº¦è®¾è®¡**ï¼š  
   ç®€å•éœ€æ±‚ç›´æ¥ç”¨è™šå‡½æ•°ï¼ˆå¦‚å°å‹é¡¹ç›®ã€ç¨³å®šé€»è¾‘ï¼‰ã€‚
4. **ç»“åˆç°ä»£ C++ ç‰¹æ€§**ï¼š  
   - ä½¿ç”¨ `std::function` + lambda æ›¿ä»£ä¼ ç»Ÿç­–ç•¥æ¨¡å¼ã€‚
   - ç”¨æ™ºèƒ½æŒ‡é’ˆï¼ˆå¦‚ `std::unique_ptr`ï¼‰ç®¡ç†ç­–ç•¥å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚

> â€œè™šå‡½æ•°æ˜¯é”¤å­ï¼Œä½†å¹¶éæ‰€æœ‰é—®é¢˜éƒ½æ˜¯é’‰å­ã€‚â€â€”â€”æ¡æ¬¾ 35 çš„ç²¾é«“åœ¨äº **æ‹“å®½è®¾è®¡è§†é‡**ï¼Œåœ¨é¢å‘å¯¹è±¡ä¸æ³›å‹ç¼–ç¨‹é—´çµæ´»åˆ‡æ¢ï¼Œä»¥æå‡ä»£ç çš„é€‚åº”æ€§ä¸å¥å£®æ€§ã€‚
