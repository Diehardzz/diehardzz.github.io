---
layout: post
title: Effective C++ æ¡æ¬¾49ï¼šäº†è§£new-handlerè¡Œä¸º
categories: [é˜…è¯»ç¬”è®°, Effective C++]
tag: [Effective C++]
date: '2025-07-30 03:45:00 +0800'
---

## **Effective C++ æ¡æ¬¾49 ï¼šäº†è§£new-handlerè¡Œä¸º**

---

<br/>

### âš™ï¸ ä¸€ã€`new-handler`æœºåˆ¶çš„åŸç†ä¸ä½œç”¨

1. **`operator new`å¤±è´¥æ—¶çš„é»˜è®¤è¡Œä¸º**  
   å½“`operator new`æ— æ³•æ»¡è¶³å†…å­˜è¯·æ±‚æ—¶ï¼š
   - **æ—§å¼ç¼–è¯‘å™¨**ï¼šè¿”å›`nullptr`ï¼ˆå·²è¿‡æ—¶ï¼‰ã€‚
   - **ç°ä»£C++**ï¼šæŠ›å‡º`std::bad_alloc`å¼‚å¸¸ã€‚  
   åœ¨æŠ›å‡ºå¼‚å¸¸å‰ï¼Œä¼šå…ˆè°ƒç”¨**å®¢æˆ·æŒ‡å®šçš„é”™è¯¯å¤„ç†å‡½æ•°**â€”â€”å³`new-handler`ã€‚

2. **`new-handler`çš„å®šä¹‰ä¸è®¾ç½®**  
   - **ç±»å‹**ï¼š`std::new_handler`æ˜¯å‡½æ•°æŒ‡é’ˆç±»å‹ï¼š`typedef void (*new_handler)();`ã€‚
   - **è®¾ç½®æ–¹æ³•**ï¼šé€šè¿‡`std::set_new_handler`æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°ï¼š
     ```cpp
     void CustomHandler() { 
         std::cerr << "Memory allocation failed!";
         std::abort(); 
     }
     int main() {
         std::set_new_handler(CustomHandler); // æ³¨å†Œå¤„ç†å‡½æ•°
         int* p = new int[1e15]; // è§¦å‘å¤±è´¥ï¼Œè°ƒç”¨CustomHandler
     }
     ```
     è‹¥æœªè®¾ç½®`new-handler`ï¼Œåˆ™ç›´æ¥æŠ›å‡º`std::bad_alloc`ã€‚

---

### ğŸ› ï¸ äºŒã€è®¾è®¡æœ‰æ•ˆçš„`new-handler`ç­–ç•¥

ä¸€ä¸ªåˆç†çš„`new-handler`åº”è‡³å°‘å®ç°ä»¥ä¸‹**ç­–ç•¥ä¹‹ä¸€**ï¼š  
1. **é‡Šæ”¾å¯ç”¨å†…å­˜**  
   - é¢„å…ˆåˆ†é…å¤‡ç”¨å†…å­˜æ± ï¼Œåœ¨è§¦å‘`new-handler`æ—¶é‡Šæ”¾ï¼Œä½¿åç»­åˆ†é…å¯èƒ½æˆåŠŸã€‚
2. **åˆ‡æ¢å¤„ç†å‡½æ•°**  
   - åŠ¨æ€æ›¿æ¢`new-handler`ï¼ˆå¦‚é€šè¿‡å…¨å±€å˜é‡æ§åˆ¶ï¼‰ï¼Œå°è¯•ä¸åŒæ¢å¤ç­–ç•¥ã€‚
3. **å¸è½½è‡ªèº«å¹¶é€€å‡º**  
   - è°ƒç”¨`std::set_new_handler(nullptr)`å¸è½½å½“å‰å¤„ç†å‡½æ•°ï¼Œè®©åç»­å¤±è´¥ç›´æ¥æŠ›å¼‚å¸¸ã€‚
4. **ç»ˆæ­¢ç¨‹åº**  
   - è°ƒç”¨`std::abort()`æˆ–`std::exit()`ï¼Œé¿å…ç¨‹åºè¿›å…¥ä¸å¯é¢„æµ‹çŠ¶æ€ã€‚

---

### ğŸ§© ä¸‰ã€å®ç°ç±»ä¸“å±`new-handler`ï¼ˆæ ¸å¿ƒæŠ€å·§ï¼‰

C++ä¸æ”¯æŒç±»çº§åˆ«çš„`new-handler`ï¼Œä½†å¯é€šè¿‡**é™æ€æˆå‘˜ä¸RAII**æ¨¡æ‹Ÿè¯¥è¡Œä¸ºï¼š  
#### **æ–¹æ³•1ï¼šæ‰‹åŠ¨ç®¡ç†æ¯ä¸ªç±»çš„å¤„ç†å‡½æ•°**  
```cpp
class Widget {
public:
    static std::new_handler set_new_handler(std::new_handler p);
    static void* operator new(std::size_t size);
private:
    static std::new_handler currentHandler; // ç±»ä¸“å±å¤„ç†å‡½æ•°
};

std::new_handler Widget::currentHandler = nullptr;

void* Widget::operator new(std::size_t size) {
    NewHandlerHolder h(std::set_new_handler(currentHandler)); // RAIIåŒ…è£…å™¨
    return ::operator new(size); // è°ƒç”¨å…¨å±€operator new
}
```
**å…³é”®ç‚¹**ï¼š  
- **RAIIç±»`NewHandlerHolder`**ï¼šåœ¨æ„é€ æ—¶ä¿å­˜æ—§å¤„ç†å‡½æ•°ï¼Œææ„æ—¶è‡ªåŠ¨æ¢å¤ï¼Œé¿å…å¼‚å¸¸å¯¼è‡´çŠ¶æ€æ®‹ç•™ã€‚
- **é™æ€æˆå‘˜`currentHandler`**ï¼šå­˜å‚¨ç±»ä¸“å±çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚

#### **æ–¹æ³•2ï¼šæ¨¡æ¿åŒ–å®ç°ï¼ˆæ¨èï¼‰**  
```cpp
template<typename T>
class NewHandlerSupport {
public:
    static std::new_handler set_new_handler(std::new_handler p);
    static void* operator new(std::size_t size);
private:
    static std::new_handler currentHandler;
};

template<typename T>
std::new_handler NewHandlerSupport<T>::currentHandler = nullptr;

class Widget : public NewHandlerSupport<Widget> {}; // ç»§æ‰¿æ¨¡æ¿
```
**ä¼˜åŠ¿**ï¼š  
- **ç±»å‹å‚æ•°`T`**ï¼šä¸ºæ¯ä¸ªæ´¾ç”Ÿç±»ç”Ÿæˆç‹¬ç«‹çš„`currentHandler`é™æ€å®ä¾‹ï¼Œé¿å…æ‰‹åŠ¨é‡å¤å®ç°ã€‚
- **å¤ç”¨æ€§**ï¼šä»»ä½•ç±»åªéœ€ç»§æ‰¿`NewHandlerSupport`å³å¯è·å¾—ä¸“å±`new-handler`æ”¯æŒã€‚

---

### âš ï¸ å››ã€æ³¨æ„äº‹é¡¹ä¸é™·é˜±

1. **`nothrow new`çš„å±€é™æ€§**  
   `new (std::nothrow)`ä»…æŠ‘åˆ¶å†…å­˜åˆ†é…é˜¶æ®µçš„å¼‚å¸¸ï¼Œ**åç»­æ„é€ å‡½æ•°ä»å¯èƒ½æŠ›å‡ºå¼‚å¸¸**ï¼Œå› æ­¤æ— æ³•å®Œå…¨é¿å…å¼‚å¸¸å¤„ç†ã€‚
2. **å¤„ç†å‡½æ•°ä¸­çš„å†…å­˜åˆ†é…**  
   åœ¨`new-handler`å†…éƒ¨**é¿å…è§¦å‘äºŒæ¬¡å†…å­˜åˆ†é…**ï¼Œå¦åˆ™å¯èƒ½é™·å…¥æ— é™é€’å½’æˆ–ç›´æ¥ç»ˆæ­¢ã€‚
3. **å¤šçº¿ç¨‹å®‰å…¨**  
   é™æ€æˆå‘˜`currentHandler`éœ€è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼ˆå¦‚`std::atomic`æˆ–äº’æ–¥é”ï¼‰ï¼Œä½†æ¡æ¬¾æœªæ·±å…¥è®¨è®ºï¼Œå®è·µä¸­éœ€é¢å¤–å¤„ç†ã€‚

---

### ğŸ’ äº”ã€æ€»ç»“ä¸æœ€ä½³å®è·µ

| **å…³é”®ç‚¹**       | **å®è·µå»ºè®®**                                              |
| ---------------- | --------------------------------------------------------- |
| **ç†è§£é»˜è®¤è¡Œä¸º** | å†…å­˜å¤±è´¥æ—¶å…ˆè°ƒç”¨`new-handler`ï¼Œæœªè®¾ç½®åˆ™æŠ›`std::bad_alloc` |
| **è®¾è®¡å¤„ç†ç­–ç•¥** | ä¼˜å…ˆå®ç°â€œé‡Šæ”¾å¤‡ç”¨å†…å­˜â€æˆ–â€œåˆ‡æ¢å¤„ç†å‡½æ•°â€ï¼Œé¿å…æ— æ•ˆæ“ä½œ      |
| **ç±»ä¸“å±å¤„ç†**   | ä½¿ç”¨æ¨¡æ¿ç±»`NewHandlerSupport`å®ç°é›¶é‡å¤ä»£ç                |
| **èµ„æºç®¡ç†**     | ç”¨RAIIï¼ˆå¦‚`NewHandlerHolder`ï¼‰ç¡®ä¿å¤„ç†å‡½æ•°çŠ¶æ€å®‰å…¨æ¢å¤    |

> Scott Meyerså¼ºè°ƒï¼š`new-handler`æœºåˆ¶æ˜¯C++å¯¹å†…å­˜æ§åˆ¶æƒçš„ç§»äº¤ï¼Œ**ç†è§£å…¶é€’å½’è°ƒç”¨æœ¬è´¨**ï¼ˆå¤„ç†å‡½æ•°å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ï¼‰æ˜¯é¿å…æ­»å¾ªç¯çš„å…³é”®ã€‚ å®è·µä¸­åº”ç»“åˆä¸šåŠ¡åœºæ™¯é€‰æ‹©ç­–ç•¥ï¼Œå¦‚å®æ—¶ç³»ç»Ÿå¯èƒ½ç›´æ¥ç»ˆæ­¢ï¼Œè€ŒæœåŠ¡ç«¯ç¨‹åºå¯èƒ½å°è¯•é‡Šæ”¾ç¼“å­˜ã€‚
