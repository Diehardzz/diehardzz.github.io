---
layout: post
title: Effective C++ æ¡æ¬¾51ï¼šç¼–å†™newå’Œdeleteæ—¶éœ€å›ºå®ˆå¸¸è§„
categories: [é˜…è¯»ç¬”è®°, Effective C++]
tag: [Effective C++]
date: '2025-07-30 20:01:01 +0800'
---

## **Effective C++ æ¡æ¬¾51 ï¼šç¼–å†™newå’Œdeleteæ—¶éœ€å›ºå®ˆå¸¸è§„**

---

<br/>

> Effective C++æ¡æ¬¾51çš„æ ¸å¿ƒåœ¨äº**å®‰å…¨å®ç°è‡ªå®šä¹‰å†…å­˜ç®¡ç†å‡½æ•°**ï¼ˆ`operator new`/`operator delete`ï¼‰æ—¶éœ€éµå¾ªçš„å…³é”®è§„åˆ™ã€‚è¿™äº›è§„åˆ™ç¡®ä¿è‡ªå®šä¹‰å†…å­˜ç®¡ç†å™¨ä¸C++æ ‡å‡†è¡Œä¸ºå…¼å®¹ï¼Œé¿å…èµ„æºæ³„æ¼ã€æœªå®šä¹‰è¡Œä¸ºåŠç»§æ‰¿ä½“ç³»ä¸­çš„éšæ‚£ã€‚
{: .prompt-info}

### âš™ï¸ **ä¸€ã€`operator new`çš„å®ç°è§„èŒƒ**

#### 1. **å¤„ç†0å­—èŠ‚è¯·æ±‚**

   - **æ ‡å‡†è¦æ±‚**ï¼šC++è§„å®šå³ä½¿è¯·æ±‚0å­—èŠ‚ï¼Œ`operator new`ä¹Ÿå¿…é¡»è¿”å›åˆæ³•æŒ‡é’ˆï¼ˆä¸èƒ½è¿”å›`nullptr`ï¼‰ã€‚
   - **å®ç°ç­–ç•¥**ï¼šå°†0å­—èŠ‚è¯·æ±‚è§†ä¸º1å­—èŠ‚è¯·æ±‚ï¼š
     ```cpp
     void* operator new(std::size_t size) throw(std::bad_alloc) {
         if (size == 0) size = 1;  // 0å­—èŠ‚è§†ä¸º1å­—èŠ‚
         while (true) {
             void* ptr = malloc(size);
             if (ptr) return ptr;
             // åˆ†é…å¤±è´¥æ—¶è°ƒç”¨new-handlerï¼ˆè§ä¸‹æ–‡ï¼‰
         }
     }
     ```

#### 2. **å¤„ç†ç»§æ‰¿ä½“ç³»ä¸­çš„å¤§å°ä¸åŒ¹é…**

   - **é—®é¢˜**ï¼šåŸºç±»çš„`operator new`å¯èƒ½è¢«æ´¾ç”Ÿç±»ç»§æ‰¿ä½¿ç”¨ï¼Œä½†åŸºç±»åˆ†é…å™¨ä»…ä¼˜åŒ–`sizeof(Base)`å¯¹è±¡ã€‚è‹¥ç”¨äºåˆ†é…æ´¾ç”Ÿç±»å¯¹è±¡ï¼ˆ`sizeof(Derived) > sizeof(Base)`ï¼‰ï¼Œä¼šå¯¼è‡´å†…å­˜ä¸è¶³ã€‚
   - **è§£æ³•**ï¼šæ£€æŸ¥è¯·æ±‚å¤§å°ï¼Œä¸åŒ¹é…æ—¶è½¬äº¤å…¨å±€`operator new`ï¼š
     ```cpp
     void* Base::operator new(std::size_t size) throw(std::bad_alloc) {
         if (size != sizeof(Base)) 
             return ::operator new(size); // éBaseå¯¹è±¡è½¬äº¤å…¨å±€å¤„ç†
         // å¦åˆ™æ‰§è¡ŒBaseä¸“å±åˆ†é…é€»è¾‘
     }
     ```

#### 3. **å¼‚å¸¸å®‰å…¨ä¸new-handleræœºåˆ¶**

   - **å¾ªç¯å°è¯•åˆ†é…**ï¼šåœ¨å¾ªç¯ä¸­å°è¯•åˆ†é…ï¼Œæ¯æ¬¡å¤±è´¥åè°ƒç”¨å½“å‰`new-handler`å‡½æ•°ï¼ˆå¯èƒ½é‡Šæ”¾å¤‡ç”¨å†…å­˜ï¼‰ã€‚
   - **new-handlerå¤„ç†**ï¼š
     ```cpp
     while (true) {
         void* ptr = customAlloc(size); // è‡ªå®šä¹‰åˆ†é…é€»è¾‘
         if (ptr) return ptr;
         std::new_handler globalHandler = std::set_new_handler(nullptr);
         std::set_new_handler(globalHandler);
         if (globalHandler) (*globalHandler)(); // è°ƒç”¨å¤„ç†å‡½æ•°
         else throw std::bad_alloc();
     }
     ```

---

### âš ï¸ **äºŒã€`operator delete`çš„å®ç°è§„èŒƒ**

#### 1. **å®‰å…¨å¤„ç†ç©ºæŒ‡é’ˆ**

   - **æ ‡å‡†è¦æ±‚**ï¼šåˆ é™¤`nullptr`å¿…é¡»å®‰å…¨æ— å‰¯ä½œç”¨ã€‚
   - **å®ç°**ï¼šæ˜¾å¼æ£€æŸ¥å¹¶è·³è¿‡ï¼š
     ```cpp
     void operator delete(void* rawMemory) noexcept {
         if (rawMemory == nullptr) return; // ç©ºæŒ‡é’ˆç›´æ¥è¿”å›
         customDealloc(rawMemory); // æ‰§è¡Œé‡Šæ”¾é€»è¾‘
     }
     ```

#### 2. **å¤„ç†ç±»ä¸“å±ç‰ˆæœ¬çš„å¤§å°ä¸åŒ¹é…**

   - **æ´¾ç”Ÿç±»åˆ é™¤åŸºç±»æŒ‡é’ˆ**ï¼šè‹¥åŸºç±»æœªå£°æ˜è™šææ„å‡½æ•°ï¼Œä¼ é€’ç»™`operator delete`çš„`size`å‚æ•°å¯èƒ½é”™è¯¯ï¼ˆå› å¯¹è±¡å¤§å°è®¡ç®—ä¾èµ–è™šè¡¨ï¼‰ã€‚
   - **å®‰å…¨æªæ–½**ï¼š
     ```cpp
     void Base::operator delete(void* rawMemory, std::size_t size) noexcept {
         if (rawMemory == nullptr) return;
         if (size != sizeof(Base)) {
             ::operator delete(rawMemory); // å¤§å°é”™è¯¯è½¬äº¤å…¨å±€delete
             return;
         }
         customDealloc(rawMemory); // ä¸“å±é‡Šæ”¾é€»è¾‘
     }
     ```

---

### ğŸ” **ä¸‰ã€å…³é”®é™·é˜±ä¸è§„é¿ç­–ç•¥**

#### 1. **æ•°ç»„åˆ†é…çš„ç‰¹æ®Šæ€§**

   - **`operator new[]`çš„sizeå‚æ•°**ï¼šå¯èƒ½åŒ…å«é¢å¤–ä¿¡æ¯ï¼ˆå¦‚å…ƒç´ æ•°é‡ï¼‰ï¼Œä¸èƒ½å‡è®¾`size = n * sizeof(T)`ã€‚
   - **åº”å¯¹**ï¼šç±»ä¸“å±ç‰ˆæœ¬éœ€ä¸å•ä¸€å¯¹è±¡ç‰ˆæœ¬åˆ†ç¦»ï¼Œé¿å…é€»è¾‘ä¾èµ–æ•°ç»„å…ƒç´ å¤§å°ã€‚

#### 2. **å¤šçº¿ç¨‹å®‰å…¨æ€§**

   - **å…¨å±€çŠ¶æ€ç«äº‰**ï¼šè‡ªå®šä¹‰å†…å­˜ç®¡ç†å™¨éœ€è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼ˆå¦‚ä½¿ç”¨åŸå­æ“ä½œä¿æŠ¤åˆ†é…é˜Ÿåˆ—ï¼‰ã€‚
   - **ç±»ä¸“å±ç‰ˆæœ¬**ï¼šé™æ€æˆå‘˜å˜é‡éœ€åŠ é”æˆ–ä½¿ç”¨`thread_local`ã€‚

#### 3. **ä¸æ„é€ /ææ„çš„äº¤äº’**

   - **æ„é€ å‡½æ•°å¼‚å¸¸**ï¼šè‹¥`operator new`æˆåŠŸä½†æ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è‡ªåŠ¨è°ƒç”¨åŒ¹é…çš„`operator delete`é‡Šæ”¾å†…å­˜ï¼ˆç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥æ­¤é€»è¾‘ï¼‰ã€‚

---

### ğŸ’ **å››ã€åº”ç”¨åœºæ™¯ä¸å†³ç­–å»ºè®®**

| **åœºæ™¯**           | **æ˜¯å¦æ¨èè‡ªå®šä¹‰`new/delete`** | **é£é™©ç­‰çº§** | **æ›¿ä»£æ–¹æ¡ˆ**                |
| ------------------ | ------------------------------ | ------------ | --------------------------- |
| é«˜é¢‘å°å¯¹è±¡åˆ†é…     | âœ… å¼ºçƒˆæ¨è                     | ä¸­           | ç±»ä¸“å±åˆ†é…å™¨ + å†…å­˜æ±        |
| å†…å­˜ä½¿ç”¨ç»Ÿè®¡/è°ƒè¯•  | âœ… æ¨è                         | ä½           | å…¨å±€é’©å­æˆ–ä»£ç†åˆ†é…å™¨        |
| ç¡¬ä»¶è¦æ±‚ç‰¹æ®Šå¯¹é½   | âœ… å¿…é¡»                         | é«˜           | `align_val_t`å‚æ•°ï¼ˆC++17ï¼‰  |
| å¤šçº¿ç¨‹é«˜æ€§èƒ½åˆ†é…   | âœ… æ¨è                         | ä¸­           | TLSå†…å­˜æ±  + æ— é”é˜Ÿåˆ—        |
| ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§è¦æ±‚ | âŒ é¿å…                         | æé«˜         | å®¹å™¨å®šåˆ¶åˆ†é…å™¨ï¼ˆAllocatorï¼‰ |

> **æœ€ä½³å®è·µæ€»ç»“**ï¼š
> 1. **ä¼˜å…ˆç±»ä¸“å±ç‰ˆæœ¬**ï¼šé¿å…å…¨å±€æ›¿æ¢ï¼Œå‡å°‘å†²çªé£é™©ã€‚
> 2. **ä¸¥æ ¼éµå¾ªæ ‡å‡†è¡Œä¸º**ï¼šåŒ…æ‹¬0å­—èŠ‚ã€ç©ºæŒ‡é’ˆã€å¤§å°ä¸åŒ¹é…ç­‰è¾¹ç•Œæƒ…å†µã€‚
> 3. **ä¸RAIIç»“åˆ**ï¼šåœ¨èµ„æºç®¡ç†ç±»ï¼ˆå¦‚æ™ºèƒ½æŒ‡é’ˆï¼‰ä¸­å°è£…è‡ªå®šä¹‰å†…å­˜ç®¡ç†ï¼Œè€Œéç›´æ¥æš´éœ²`new/delete`ã€‚
> 4. **æ€§èƒ½æµ‹è¯•**ï¼šè‡ªå®šä¹‰åˆ†é…å™¨éœ€é€šè¿‡æ€§èƒ½å‹æµ‹éªŒè¯ä¼˜åŒ–æ•ˆæœï¼Œé¿å…å¼•å…¥æ–°ç“¶é¢ˆã€‚

---

### âš¡ **äº”ã€ä»£ç ç¤ºä¾‹ï¼šå¸¦ç»Ÿè®¡çš„ç±»ä¸“å±åˆ†é…å™¨**

```cpp
class MemoryTrackedObject {
public:
    static void* operator new(std::size_t size) {
        if (size != sizeof(MemoryTrackedObject))
            return ::operator new(size);
        totalAllocations += size;
        void* ptr = malloc(size);
        if (!ptr) throw std::bad_alloc();
        return ptr;
    }

    static void operator delete(void* ptr, std::size_t size) noexcept {
        if (!ptr) return;
        if (size != sizeof(MemoryTrackedObject)) {
            ::operator delete(ptr);
            return;
        }
        totalDeallocations += size;
        free(ptr);
    }
private:
    static std::atomic<size_t> totalAllocations;
    static std::atomic<size_t> totalDeallocations;
};
```

æ­¤å®ç°æ»¡è¶³æ¡æ¬¾51æ‰€æœ‰æ ¸å¿ƒè¦æ±‚ï¼š
- å¤„ç†0å­—èŠ‚ï¼ˆé€šè¿‡å…¨å±€`new`é—´æ¥æ”¯æŒï¼‰
- æ£€æŸ¥å¤§å°ä¸åŒ¹é…ï¼ˆè½¬äº¤å…¨å±€ç‰ˆæœ¬ï¼‰
- çº¿ç¨‹å®‰å…¨ï¼ˆ`std::atomic`è®¡æ•°ï¼‰
- ç©ºæŒ‡é’ˆå®‰å…¨ï¼ˆæ˜¾å¼æ£€æŸ¥ï¼‰

Scott Meyerså¼ºè°ƒï¼š**è‡ªå®šä¹‰`new/delete`æ˜¯â€œæœ€æ¥è¿‘é‡‘å±â€çš„C++ç‰¹æ€§ï¼Œå…¶æ­£ç¡®æ€§ç›´æ¥å½±å“ç¨‹åºæ ¹åŸº**ã€‚ç†è§£å¹¶éµå®ˆä¸Šè¿°è§„åˆ™ï¼Œæ–¹èƒ½åœ¨æ€§èƒ½ä¼˜åŒ–ä¸ç³»ç»Ÿç¨³å®šæ€§é—´å–å¾—å¹³è¡¡ã€‚
